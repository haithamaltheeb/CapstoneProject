{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - StrumNation</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1><i class="fas fa-music"></i> StrumNation</h1>
            </div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <form method="GET" action="{% url 'search' %}" id="searchForm">
                    <input type="text" name="q" class="search-input" placeholder="Search instruments..." id="searchInput">
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
                <div class="search-results" id="searchResults" style="display: none;"></div>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <nav class="nav" id="nav">
                <ul class="nav-list">
                    <li><a href="{% url 'home' %}" class="nav-link">Home</a></li>
                    <li><a href="{% url 'view_cart' %}" class="nav-link">Cart <span class="cart-count" id="cartCount">{{ items|length }}</span></a></li>
                    <li><a href="{% url 'logout' %}" class="logout-btn">Logout</a></li>
                    {% if user.is_superuser %}
                        <li><a href="{% url 'add_product' %}" class="nav-link">Admin: Add Product</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <main class="main">
        <section class="cart-section">
            <div class="container">
                <h2 class="section-title">
                    <i class="fas fa-shopping-cart"></i>
                    Your Shopping Cart
                </h2>
                
                {% if items %}
                    <div class="cart-container">
                        <div class="cart-items">
                            {% for item in items %}
                                <div class="cart-item" data-item-id="{{ item.id }}">
                                    <div class="cart-item-image">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                                        {% else %}
                                            <div class="no-image">{{ item.product.name|slice:":1" }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="cart-item-details">
                                        <h3 class="cart-item-name">{{ item.product.name }}</h3>
                                        <p class="cart-item-category">{{ item.product.category.name }}</p>
                                        <p class="cart-item-price">${{ item.product.price }}</p>
                                    </div>
                                    
                                    <div class="cart-item-quantity">
                                        <button class="quantity-btn minus" data-action="decrease" data-item-id="{{ item.id }}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="quantity-display">{{ item.quantity }}</span>
                                        <button class="quantity-btn plus" data-action="increase" data-item-id="{{ item.id }}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="cart-item-subtotal">
                                        <span class="subtotal-amount">${{ item.subtotal }}</span>
                                    </div>
                                    
                                    <div class="cart-item-actions">
                                        <button class="remove-btn" data-action="remove" data-item-id="{{ item.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="cart-summary">
                            <div class="summary-card">
                                <h3>Order Summary</h3>
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span class="subtotal-total">${{ total }}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Shipping:</span>
                                    <span class="shipping-cost">$0.00</span>
                                </div>
                                <div class="summary-row total-row">
                                    <span>Total:</span>
                                    <span class="total-amount">${{ total }}</span>
                                </div>
                                
                                <button class="checkout-btn" onclick="window.location.href='{% url 'checkout' %}'">
                                    <i class="fas fa-credit-card"></i>
                                    Proceed to Checkout
                                </button>
                                
                                <a href="{% url 'home' %}" class="continue-shopping">
                                    <i class="fas fa-arrow-left"></i>
                                    Continue Shopping
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-cart">
                        <div class="empty-cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3>Your cart is empty</h3>
                        <p>Looks like you haven't added any instruments to your cart yet.</p>
                        <a href="{% url 'home' %}" class="cta-btn">
                            <i class="fas fa-music"></i>
                            Start Shopping
                        </a>
                    </div>
                {% endif %}
            </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3><i class="fas fa-music"></i> StrumNation</h3>
          <p>Your ultimate destination for premium musical instruments. We provide the finest guitars, drums, pianos, and more to musicians worldwide.</p>
        </div>
        
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="{% url 'home' %}">Home</a></li>
            <li><a href="{% url 'category_products' 'Guitars' %}">Guitars</a></li>
            <li><a href="{% url 'category_products' 'Drums' %}">Drums</a></li>
            <li><a href="{% url 'category_products' 'Pianos' %}">Pianos</a></li>
            <li><a href="{% url 'category_products' 'Strings' %}">Strings</a></li>
            <li><a href="{% url 'category_products' 'Amplifiers' %}">Amplifiers</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4>Contact Info</h4>
          <div class="contact-info">
            <p><i class="fas fa-envelope"></i> Haitham.deeb8@gmail.com</p>
            <p><i class="fas fa-phone"></i> +962790010458</p>
            <p><i class="fas fa-map-marker-alt"></i> Jordan</p>
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2024 StrumNation. All rights reserved. | Powered by <strong>Haitham AlTheeb</strong></p>
      </div>
    </div>
  </footer>

  <script>
        // Mobile Menu Toggle
        document.getElementById('mobileMenuToggle').addEventListener('click', function() {
            const nav = document.getElementById('nav');
            nav.classList.toggle('active');
        });

        // Cart functionality
        document.addEventListener('click', function(e) {
            const action = e.target.closest('[data-action]');
            if (!action) return;

            const itemId = action.dataset.itemId;
            const actionType = action.dataset.action;
            
            if (actionType === 'remove') {
                removeItem(itemId);
            } else if (actionType === 'increase' || actionType === 'decrease') {
                updateQuantity(itemId, actionType);
            }
        });

        function removeItem(itemId) {
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                fetch(`/cart/remove/${itemId}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function updateQuantity(itemId, action) {
            const quantityDisplay = document.querySelector(`[data-item-id="${itemId}"] .quantity-display`);
            const currentQuantity = parseInt(quantityDisplay.textContent);
            let newQuantity = action === 'increase' ? currentQuantity + 1 : currentQuantity - 1;
            
            if (newQuantity <= 0) {
                removeItem(itemId);
                return;
            }

            const formData = new FormData();
            formData.append('quantity', newQuantity);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            fetch(`/cart/update/${itemId}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/search/?q=${encodeURIComponent(query)}&ajax=1`)
                    .then(response => response.json())
                    .then(data => {
                        displaySearchResults(data.results);
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                    });
            }, 300);
        });

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No products found</div>';
            } else {
                searchResults.innerHTML = results.map(product => `
                    <div class="search-result-item" onclick="window.location.href='/category/${product.category}/'">
                        <div class="search-result-image">
                            ${product.name.charAt(0)}
                        </div>
                        <div class="search-result-details">
                            <h4>${product.name}</h4>
                            <p>$${product.price}</p>
                        </div>
                    </div>
                `).join('');
            }
            searchResults.style.display = 'block';
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.search-container')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>